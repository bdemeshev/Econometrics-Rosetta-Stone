## R

Загружаем нужные пакеты:
```{r "packages", results='hide', message=FALSE, warning=FALSE}
library(ggplot2) # построение графиков
library(gridExtra) # визуализация
library(dplyr) # работа с данными
library(skimr) # изучение данных
library(Ecdat) #  работа с инструментальными переменными
library(AER) #  работа с инструментальными переменными
library(ggcorrplot) # построения коррелограмы. 
```

Установить пакет ggcorrplot можно следующей командой:
```{r "ggcorrplot", warning=FALSE, message=FALSE}
devtools::install_github("kassambara/ggcorrplot")
```

Загружаем данные по продаже недвижимости **Housing**, изучаем их строение, представляем на графиках:
```{r "eda", warning=FALSE, message=FALSE}
skim(Housing)
theme_set(theme_classic())

ggplot(data = Housing) + 
  scale_fill_brewer(palette = "Spectral") + 
  geom_histogram(mapping = aes(x = price), color = "gray2") +
  labs(title = "Распределение цены", y = "Количество наблюдений", x = "Цена дома (в $)")  

ggplot(data = Housing) + 
  scale_fill_brewer(palette = "Spectral") + 
  geom_histogram(mapping = aes(x = bedrooms), fill = "tomato1") +
  labs(title = "Распределение количества кроватей", y = "Количество наблюдений", 
  x = "Количество кроватей")  

ggplot(data = Housing) + 
  scale_fill_brewer(palette = "Spectral") + 
  geom_histogram(mapping = aes(x = lotsize), fill = "#FFDB6D", color = "#C4961A") +
  labs(title = "Распределение размера дома", y = "Количество наблюдений", 
  x = "Размер дома (в квадратных метрах)") 
 
```

Используем для предсказания цены дома `price` количество кроватей в нем `bedrooms`, а  площадь дома `lotsize` будем использовать как инструмент.

Убедимся, что между ними есть связь, посчитав корреляцию. Заодно построим нехитрую корреляционную матрицу для всех численных переменных:
```{r "correlation"}
cor(Housing$lotsize, Housing$bedrooms) # считаем связь между переменной и инструментом
housing_numeric = select_if(Housing, is.numeric) # оставляем только численные переменные
cor_housing = cor(housing_numeric)
ggcorrplot(cor_housing, hc.order = TRUE,
           type = "lower",
           lab = TRUE,
           lab_size = 3,
           method = "circle",
           colors = c("tomato2", "white", "springgreen3"),
           title = "Корреляция переменных",
           ggtheme = theme_bw)
```

Действительно, между выбранными нами переменной и инструментом наблюдается корреляция, которая составляет 0.15.

Построим IV-регрессию, реализующую двухшаговый МНК, с помощью функции *ivreg*:
```{r "ivreg", include=TRUE}
iv1 = ivreg(price ~ bedrooms | lotsize, data = Housing)
summary(iv1)
```
Обратите внимание на синтаксис функции - он схож с простой регрессией. Первая переменная - зависимая, после знака `~` указываются регрессоры. После вертикальной черты `|` указываются инструментальные переменные. В поле *data* мы ссылаемся на данные, которые анализируем.

Мы видим, что влияние размера дома на цену значительно снизилось после использования инструментальной переменной. Значит, размер дома и количество кроватей в нем тесно связаны.

Чтобы полностью в этом убедиться, проведем тесты.
```{r "diagnostic tests"}
summary(iv1, vcov = sandwich, diagnostics = TRUE)
```

Смотрим на раздел *Diagnostic tests*. Нас интересует тест на слабость инструментов, *Weak instruments*. Нулевая гипотеза заключается в том, что выбранный инструмент слабый. На любом разумном уровне значимости мы можем говорить о том, что гипотеза отвергается, а значит, выбранный инструмент неслабый. Следующий тест, *Wu-Hausman*, проверяет основную гипотезу о постоянстве МНК-оценок. Так как мы отвергаем основную гипотезу на любом разумном уровне значимости, оценки МНК не постоянны, то есть, присутствует эндогенность и МНК-оценки смещены, поэтому использование инструментов оправданно. *Тест Sargan*, проверяющий экзогенность инструментов, может применяться только в том случае, если количество инструментов превышает количество эндогенных переменных. В нашем случае данный тест не применим, так как мы выбрали только одну инструментальную переменную для одного регрессора. 

Добавим еще одну инструментальную переменную, `bathrms`, содержащую информацию о количестве ванных комнат, и проведем *тест Sargan*.
```{r "sargan"}
iv2 = ivreg(price ~ bedrooms | lotsize + bathrms, data = Housing)
summary(iv2)
summary(iv2, vcov = sandwich, diagnostics = TRUE)
```
Нулевая гипотеза в *тесте Sargan* отвергается тогда, когда хотя бы один из инструментов не подходит. Так как нулевая гипотеза не отвергается на любом разумном уровне значимости, наши инструменты были подобраны хорошо.