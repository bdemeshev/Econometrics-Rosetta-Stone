<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Коан 8 Гетероскедастичность в простой регрессии | Розеттский камень</title>
  <meta name="description" content="Сборник коанов для эконометристов, жаждущих просветления.">
  <meta name="generator" content="bookdown  and GitBook 2.6.7">

  <meta property="og:title" content="Коан 8 Гетероскедастичность в простой регрессии | Розеттский камень" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Сборник коанов для эконометристов, жаждущих просветления." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Коан 8 Гетероскедастичность в простой регрессии | Розеттский камень" />
  
  <meta name="twitter:description" content="Сборник коанов для эконометристов, жаждущих просветления." />
  

<meta name="author" content="Пуассон, фея и три мексиканских негодяя">


<meta name="date" content="2020-01-16">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="arma.html">

<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Напутственное слово</a></li>
<li class="chapter" data-level="2" data-path="installsoft.html"><a href="installsoft.html"><i class="fa fa-check"></i><b>2</b> Коан об установке софта</a><ul>
<li class="chapter" data-level="2.1" data-path="installsoft.html"><a href="installsoft.html#--r"><i class="fa fa-check"></i><b>2.1</b> Язык программирования R</a><ul>
<li class="chapter" data-level="2.1.1" data-path="installsoft.html"><a href="installsoft.html#---rstudio--windows-mac-os"><i class="fa fa-check"></i><b>2.1.1</b> Инструкция по установке RStudio для Windows / Mac OS:</a></li>
<li class="chapter" data-level="2.1.2" data-path="index.html"><a href="index.html#-"><i class="fa fa-check"></i><b>2.1.2</b> Начало работы</a></li>
<li class="chapter" data-level="2.1.3" data-path="installsoft.html"><a href="installsoft.html#--1"><i class="fa fa-check"></i><b>2.1.3</b> Настройка программы [^1]</a></li>
<li class="chapter" data-level="2.1.4" data-path="installsoft.html"><a href="installsoft.html#--python"><i class="fa fa-check"></i><b>2.1.4</b> Язык программирования Python</a></li>
<li class="chapter" data-level="2.1.5" data-path="installsoft.html"><a href="installsoft.html#section-2.1.5"><i class="fa fa-check"></i><b>2.1.5</b> Установка</a></li>
<li class="chapter" data-level="2.1.6" data-path="installsoft.html"><a href="installsoft.html#--1"><i class="fa fa-check"></i><b>2.1.6</b> Начало работы</a></li>
<li class="chapter" data-level="2.1.7" data-path="installsoft.html"><a href="installsoft.html#-stata"><i class="fa fa-check"></i><b>2.1.7</b> Программа STATA</a></li>
<li class="chapter" data-level="2.1.8" data-path="installsoft.html"><a href="installsoft.html#-1"><i class="fa fa-check"></i><b>2.1.8</b> Установка:</a></li>
<li class="chapter" data-level="2.1.9" data-path="installsoft.html"><a href="installsoft.html#--2"><i class="fa fa-check"></i><b>2.1.9</b> Начало работы:</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="simplereg.html"><a href="simplereg.html"><i class="fa fa-check"></i><b>3</b> Коан о простой линейной регрессии</a><ul>
<li class="chapter" data-level="3.1" data-path="simplereg.html"><a href="simplereg.html#r"><i class="fa fa-check"></i><b>3.1</b> R</a></li>
<li class="chapter" data-level="3.2" data-path="simplereg.html"><a href="simplereg.html#python"><i class="fa fa-check"></i><b>3.2</b> Python</a></li>
<li class="chapter" data-level="3.3" data-path="simplereg.html"><a href="simplereg.html#stata"><i class="fa fa-check"></i><b>3.3</b> Stata</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="binchoice.html"><a href="binchoice.html"><i class="fa fa-check"></i><b>4</b> Модель бинарного выбора</a><ul>
<li class="chapter" data-level="4.1" data-path="binchoice.html"><a href="binchoice.html#r-1"><i class="fa fa-check"></i><b>4.1</b> R</a></li>
<li class="chapter" data-level="4.2" data-path="binchoice.html"><a href="binchoice.html#python-1"><i class="fa fa-check"></i><b>4.2</b> Python</a></li>
<li class="chapter" data-level="4.3" data-path="binchoice.html"><a href="binchoice.html#stata-1"><i class="fa fa-check"></i><b>4.3</b> Stata</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="multchoice.html"><a href="multchoice.html"><i class="fa fa-check"></i><b>5</b> Модели множественного выбора</a><ul>
<li class="chapter" data-level="5.1" data-path="multchoice.html"><a href="multchoice.html#r-2"><i class="fa fa-check"></i><b>5.1</b> R</a></li>
<li class="chapter" data-level="5.2" data-path="multchoice.html"><a href="multchoice.html#python-2"><i class="fa fa-check"></i><b>5.2</b> python</a></li>
<li class="chapter" data-level="5.3" data-path="multchoice.html"><a href="multchoice.html#stata-2"><i class="fa fa-check"></i><b>5.3</b> Stata</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="poisreg.html"><a href="poisreg.html"><i class="fa fa-check"></i><b>6</b> Модели счетных данных</a><ul>
<li class="chapter" data-level="6.1" data-path="poisreg.html"><a href="poisreg.html#r-3"><i class="fa fa-check"></i><b>6.1</b> R</a></li>
<li class="chapter" data-level="6.2" data-path="poisreg.html"><a href="poisreg.html#python-3"><i class="fa fa-check"></i><b>6.2</b> Python</a></li>
<li class="chapter" data-level="6.3" data-path="poisreg.html"><a href="poisreg.html#stata-3"><i class="fa fa-check"></i><b>6.3</b> Stata</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="arma.html"><a href="arma.html"><i class="fa fa-check"></i><b>7</b> ARMA</a><ul>
<li class="chapter" data-level="7.1" data-path="arma.html"><a href="arma.html#r-4"><i class="fa fa-check"></i><b>7.1</b> R</a></li>
<li class="chapter" data-level="7.2" data-path="arma.html"><a href="arma.html#python-4"><i class="fa fa-check"></i><b>7.2</b> Python</a></li>
<li class="chapter" data-level="7.3" data-path="arma.html"><a href="arma.html#stata-4"><i class="fa fa-check"></i><b>7.3</b> Stata</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="heterosked.html"><a href="heterosked.html"><i class="fa fa-check"></i><b>8</b> Гетероскедастичность в простой регрессии</a><ul>
<li class="chapter" data-level="8.1" data-path="heterosked.html"><a href="heterosked.html#r-5"><i class="fa fa-check"></i><b>8.1</b> R</a></li>
<li class="chapter" data-level="8.2" data-path="heterosked.html"><a href="heterosked.html#python-5"><i class="fa fa-check"></i><b>8.2</b> Python</a></li>
<li class="chapter" data-level="8.3" data-path="heterosked.html"><a href="heterosked.html#stata-5"><i class="fa fa-check"></i><b>8.3</b> Stata</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Розеттский камень</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="heterosked" class="section level1">
<h1><span class="header-section-number">Коан 8</span> Гетероскедастичность в простой регрессии</h1>
<blockquote>
<p>Одним из нарушений условий ТГМ является гетероскедастичность, возникающая ввиду неодинаковых дисперсий для разных наблюдений. Она нежелательна ввиду того, что оценки МНК не являются эффективными (но остаются несмещёнными), и предпосылки для использования <code>t</code>-статистик нарушены, что даёт неверный результат о значимости коэффициентов.</p>
</blockquote>
<p>Этот коан благословит Вас на поиски гетероскедастичности и просветит о способах борьбы с ней.</p>
<p>Будем анализировать гетероскедастичность на данных о стоимости квартир.</p>
<blockquote>
<p>Мини-теория:</p>
</blockquote>
<p><strong>Тест Уайта</strong></p>
<p>Он неконструктивный, он может лишь показать наличие гетероскедастичности, асимптотический. Нормальность остатков в предпосылках не требуется, подразумевается, что <span class="math display">\[E({\varepsilon^4_i}) = const\]</span>.</p>
<p><span class="math display">\[
\begin{cases}
H_0: \sigma^2_i = \sigma^2 \\
H_1: \sigma^2_i \neq = \sigma^2 \\
\end{cases}
\]</span></p>
<p>На первом шаге тест сохраняет остатки от построения начальной регрессии. <span class="math display">\[
\hat{\ln{(pricemetr_i)}} = \hat{\beta}_0 + \hat{\beta}_{\ln{(kitsp)}} \cdot \ln{(kitsp_i)} + \hat{\beta}_{\ln{(livesp)}}\cdot \ln{(livesp_i)} + \hat{\beta}_{\ln{(dist)}}\cdot \ln{(dist_i)} + \hat{\beta}_{\ln{(metrdist)}}\cdot \ln{(metrdist_i)}
\]</span> На втором - строится вспомогательная регрессия (X_j-вектор j-го фактора). <span class="math display">\[
\hat{e}^2_i = \hat{\alpha}_0 + \sum_{j=1}^{k} \hat{\alpha}_j \cdot X_j + \sum_{j=1}^{k} \hat{\gamma}_j \cdot X^2_j + \sum_{j &lt; m}^{k} \hat{\delta}_j X_j \cdot X_m
\]</span></p>
<p><code>R-squared</code> построенной вспомогательной регрессии должен быть распределён как: <span class="math display">\[
n \cdot R^2_{aux} \sim \chi^2_{K-1}
\]</span> где <code>K</code> – число факторов во вспомогательной регрессии.</p>
<p><strong>Тест Бройша - Пагана</strong></p>
<p>Тест Бройша - Пагана — обобщённый вариант теста Уайта. В тесте Бройша-Пагана во вспомогательной регрессии можно брать любые функции от регрессоров, в тесте Уайта - регрессоры, их квадраты и кросс-произведения. Тест Бройша-Пагана является асимптотическим.</p>
<p><span class="math display">\[
\begin{cases}
H_0: \sigma^2_i = \sigma^2 \\
H_1: \sigma^2_i \propto f(\alpha_0 + \alpha_1 \cdot Z_1 +  \ldots + \alpha_p \cdot Z_p) \\
\end{cases}
\]</span></p>
<p>Классическая версия Бройша - Пагана строится на основе метода максимального правдоподобия. Предпосылками классической версии теста являются нормальность остатков, существование у функции дисперсии из альтернативной гипотезы первой и второй производной. Считается LM-статистика, которая, при верной основной гипотезе об отсутствии гетероскедастичности, имеет хи-квадратное распределение с p-1 степенью свободы.</p>
<p>Современная модификация теста не требует нормальности остатков, лишь <span class="math display">\[{\mathbb E}({\varepsilon^4_i}) = const\]</span>.</p>
<p>На первом шаге строится исходная регрессия и сохраняются остатки. Затем строится состоятельная оценка дисперсии: <span class="math display">\[
\hat{\sigma}^2 = \frac{1}{n} \cdot \sum_{i=1}^{n} {e^2_i}
\]</span></p>
<p>Потом строится вспомогательная регрессия:</p>
<p><span class="math display">\[
\frac{e^2}{\hat{\sigma}^2} = \alpha_0 + \alpha_1 \cdot Z_1 + \ldots + \alpha_p \cdot Z_p + u
\]</span></p>
<p>И рассчитывается тестовая статистика:</p>
<p><span class="math display">\[
\frac{RSS_{aux}}{2} \sim \chi^2_{p}
\]</span></p>
<p><strong>Тест Голдфелда - Квандта</strong></p>
<p><span class="math display">\[
\begin{cases}
H_0: \sigma^2_i = \sigma^2 \\
H_1: \sigma^2_i \propto X_i \\
\end{cases}
\]</span></p>
<p>Этот тест предполагает нормальность остатков и является неасимптотическим.</p>
<p>Процедура:</p>
<p>Сначала все наблюдения сортируются по возрастанию абсолютного значения фактора, вызывающего гетероскедастичность.</p>
<p>Затем отсортированный ряд по фактору делится на 3 примерно равные части. Считаются гетероскедастичности по первой и третьей части ряда. Строится <code>F</code>- статистика:</p>
<p><span class="math display">\[
\frac{RSS_2}{RSS_1} \sim F_{r - k, r-k}
\]</span></p>
<p><strong>WLS как способ борьбы с гетероскедастичностью</strong></p>
<p>Веса – оценка обратной дисперсии переменной, вызывающей гетероскедачность.</p>
<p>То есть оценим регрессию: <span class="math display">\[
\frac{\ln{(pricemetr_i)}}{\hat{\sigma}_i} = 
\frac{\beta_0}{\hat{\sigma}_i} + 
\frac{\beta_{\ln{(kitsp)}} \cdot \ln{(kitsp_i)}}{\hat{\sigma}_i} + \frac{\beta_{\ln{(livesp)}} \cdot \ln{(livesp_i)}}{\hat{\sigma}_i} + \frac{\beta_{\ln{(dist)}} \cdot \ln{(dist_i)}}{\hat{\sigma}_i} + \frac{\beta_{\ln{(metrdist)}} \cdot \ln{(metrdist_i)}}{\hat{\sigma}_i} + \frac{\varepsilon_i}{\hat{\sigma}_i}
\]</span></p>
<p>где <code>r</code> - размер первой и третьей частей отсортированного ряда.</p>
<div id="r-5" class="section level2">
<h2><span class="header-section-number">8.1</span> R</h2>
<p>Вызовем <strong>r</strong> в помощь в охоте на гетероскедастичность. Импортируем его оружейные пакеты.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(rio) <span class="co"># импорт и экспорт данных в разных форматах</span>
<span class="kw">library</span>(dplyr) <span class="co"># манипуляции с данными</span>
<span class="kw">library</span>(lmtest) <span class="co"># тест Бройша-Пагана</span>
<span class="kw">library</span>(sandwich) <span class="co"># оценка дисперсии при гетероскедастичности</span>
<span class="kw">library</span>(UStatBookABSC) <span class="co"># WLS</span>
<span class="kw">library</span> (estimatr) <span class="co"># получение робастных оценок</span>
<span class="kw">library</span>(ggpubr) <span class="co"># для графиков</span>
<span class="kw">library</span>(skimr) <span class="co"># для описательных статистик</span></code></pre></div>
<p>Импортируем наш dataset, <code>flats.dta</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">flats=<span class="st"> </span><span class="kw">import</span>(<span class="st">&quot;flats_10.dta&quot;</span>)</code></pre></div>
<pre><code>Error in import(&quot;flats_10.dta&quot;): No such file</code></pre>
<p>Рассмотрим описательные статистики загруженного датасета.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">skim</span>(flats)</code></pre></div>
<pre><code>Skim summary statistics
 n obs: 773 
 n variables: 44 

-- Variable type:character -------------------------------------
                   variable missing complete   n min max empty n_unique
                      okrug       0      773 773   0   4     1        4
 sanuzel__1_razdel__0_sovm_       0      773 773   1   2     0        3

-- Variable type:numeric ---------------------------------------
         variable missing complete   n        mean         sd         p0
              bal       0      773 773       0.53        0.5        0   
            brick       0      773 773       0.16        0.37       0   
             dist       0      773 773      12.19        4.66       5   
            floor       0      773 773       0.83        0.38       0   
           floor1       0      773 773       0.097       0.3        0   
           floor2       0      773 773       0.074       0.26       0   
           floors       0      773 773      15.71        9.09       3   
            kitsp       0      773 773       8.09        2.85       2   
           livesp       0      773 773      21.45        7.25       8   
          ln_dist       0      773 773       2.43        0.4        1.61
       ln_dist_sq       0      773 773       6.04        1.88       2.59
        ln_floors       0      773 773       2.59        0.59       1.1 
     ln_floors_sq       0      773 773       7.05        3.03       1.21
         ln_kitsp       0      773 773       2.02        0.41       0.69
      ln_kitsp_sq       0      773 773       4.24        1.48       0.48
        ln_livesp       0      773 773       3.02        0.27       2.08
     ln_livesp_sq       0      773 773       9.22        1.74       4.32
      ln_metrdist       0      773 773       2.04        0.55       0   
   ln_metrdist_sq       0      773 773       4.49        2.07       0   
 ln_metrdist_walk       0      773 773       0.97        1.09       0   
        ln_nfloor       0      773 773       1.7         0.89       0   
     ln_nfloor_sq       0      773 773       3.69        3.04       0   
   ln_price_meter       0      773 773      12.19        0.3       11.35
    ln_price_metr       0      773 773      12.19        0.3       11.35
         ln_totsp       0      773 773       3.6         0.28       2.71
      ln_totsp_sq       0      773 773      13.01        1.94       7.33
        ln_totsp2       0      773 773      13.01        1.94       7.33
        ln_totsp3       0      773 773      28.34        8.55       8.99
         metrdist       0      773 773       8.83        4.44       1   
                n       0      773 773     395.48      228.89       1   
              new       0      773 773       0.31        0.46       0   
           nfloor       0      773 773       7.93        7.99       1   
       non_livesp       0      773 773       8.29        4.65       0   
               nw       0      773 773       0.41        0.49       0   
            price       0      773 773 7548674.66  2492693.71 3300000   
      price_meter       0      773 773  207308.48    74861.22   84930.44
            rooms       0      773 773       1           0          1   
               sw       0      773 773       0.39        0.49       0   
              tel       0      773 773       0.91        0.3        0   
            totsp       0      773 773      37.82        9.9       15   
                w       0      773 773       0.2         0.4        0   
             walk       0      773 773       0.46        0.5        0   
        p25        p50        p75        p100     hist
       0          1          1        1       &lt;U+2587&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2587&gt;
       0          0          0        1       &lt;U+2587&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2582&gt;
       9         11.5       15       25.5     &lt;U+2587&gt;&lt;U+2586&gt;&lt;U+2587&gt;&lt;U+2587&gt;&lt;U+2585&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2582&gt;
       1          1          1        1       &lt;U+2582&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2587&gt;
       0          0          0        1       &lt;U+2587&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;
       0          0          0        1       &lt;U+2587&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;
       9         14         19       48       &lt;U+2583&gt;&lt;U+2587&gt;&lt;U+2583&gt;&lt;U+2582&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2582&gt;&lt;U+2581&gt;
       6          8         10       24       &lt;U+2582&gt;&lt;U+2585&gt;&lt;U+2587&gt;&lt;U+2582&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;
      18         19         21       65       &lt;U+2581&gt;&lt;U+2587&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;
       2.2        2.44       2.71     3.24    &lt;U+2583&gt;&lt;U+2583&gt;&lt;U+2583&gt;&lt;U+2587&gt;&lt;U+2587&gt;&lt;U+2587&gt;&lt;U+2583&gt;&lt;U+2582&gt;
       4.83       5.97       7.33    10.49    &lt;U+2583&gt;&lt;U+2582&gt;&lt;U+2586&gt;&lt;U+2586&gt;&lt;U+2587&gt;&lt;U+2583&gt;&lt;U+2581&gt;&lt;U+2582&gt;
       2.2        2.64       2.94     3.87    &lt;U+2581&gt;&lt;U+2583&gt;&lt;U+2581&gt;&lt;U+2585&gt;&lt;U+2587&gt;&lt;U+2586&gt;&lt;U+2583&gt;&lt;U+2582&gt;
       4.83       6.96       8.67    14.99    &lt;U+2583&gt;&lt;U+2581&gt;&lt;U+2587&gt;&lt;U+2587&gt;&lt;U+2582&gt;&lt;U+2582&gt;&lt;U+2583&gt;&lt;U+2581&gt;
       1.79       2.08       2.3      3.18    &lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2583&gt;&lt;U+2587&gt;&lt;U+2585&gt;&lt;U+2581&gt;&lt;U+2581&gt;
       3.21       4.32       5.3     10.1     &lt;U+2582&gt;&lt;U+2582&gt;&lt;U+2586&gt;&lt;U+2587&gt;&lt;U+2586&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;
       2.89       2.94       3.04     4.17    &lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2582&gt;&lt;U+2587&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;
       8.35       8.67       9.27    17.43    &lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2587&gt;&lt;U+2582&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;
       1.61       2.3        2.3      3.69    &lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2583&gt;&lt;U+2587&gt;&lt;U+2583&gt;&lt;U+2581&gt;&lt;U+2581&gt;
       2.59       5.3        5.3     13.61    &lt;U+2582&gt;&lt;U+2586&gt;&lt;U+2583&gt;&lt;U+2587&gt;&lt;U+2583&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;
       0          0          2.08     3.69    &lt;U+2587&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2582&gt;&lt;U+2583&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;
       1.1        1.79       2.4      4.84    &lt;U+2583&gt;&lt;U+2586&gt;&lt;U+2587&gt;&lt;U+2587&gt;&lt;U+2585&gt;&lt;U+2582&gt;&lt;U+2581&gt;&lt;U+2581&gt;
       1.21       3.21       5.75    23.47    &lt;U+2587&gt;&lt;U+2585&gt;&lt;U+2582&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;
      12.03      12.15      12.32    13.3     &lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2586&gt;&lt;U+2587&gt;&lt;U+2582&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;
      12.03      12.15      12.32    13.3     &lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2586&gt;&lt;U+2587&gt;&lt;U+2582&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;
       3.47       3.64       3.74     4.32    &lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2585&gt;&lt;U+2587&gt;&lt;U+2582&gt;&lt;U+2582&gt;&lt;U+2581&gt;
      12.01      13.23      13.97    18.64    &lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2587&gt;&lt;U+2587&gt;&lt;U+2582&gt;&lt;U+2581&gt;&lt;U+2581&gt;
      12.01      13.23      13.97    18.64    &lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2587&gt;&lt;U+2587&gt;&lt;U+2582&gt;&lt;U+2581&gt;&lt;U+2581&gt;
      24.15      25.53      28.22    72.74    &lt;U+2581&gt;&lt;U+2583&gt;&lt;U+2587&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;
       5         10         10       40       &lt;U+2585&gt;&lt;U+2587&gt;&lt;U+2583&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;
     196        397        595      788       &lt;U+2587&gt;&lt;U+2587&gt;&lt;U+2587&gt;&lt;U+2587&gt;&lt;U+2587&gt;&lt;U+2587&gt;&lt;U+2587&gt;&lt;U+2587&gt;
       0          0          1        1       &lt;U+2587&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2583&gt;
       3          6         11      127       &lt;U+2587&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;
       5          8         11       25       &lt;U+2585&gt;&lt;U+2585&gt;&lt;U+2587&gt;&lt;U+2587&gt;&lt;U+2582&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;
       0          0          1        1       &lt;U+2587&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2586&gt;
 5750000    6700000    8600000        1.8e+07 &lt;U+2581&gt;&lt;U+2587&gt;&lt;U+2583&gt;&lt;U+2582&gt;&lt;U+2582&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;
  167187.5   189393.9   223076.9  6e+05       &lt;U+2582&gt;&lt;U+2587&gt;&lt;U+2582&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;
       1          1          1        1       &lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2587&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;
       0          0          1        1       &lt;U+2587&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2585&gt;
       1          1          1        3       &lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2587&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;
      32         38         42       75       &lt;U+2582&gt;&lt;U+2581&gt;&lt;U+2587&gt;&lt;U+2587&gt;&lt;U+2582&gt;&lt;U+2582&gt;&lt;U+2581&gt;&lt;U+2581&gt;
       0          0          0        1       &lt;U+2587&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2582&gt;
       0          0          1        1       &lt;U+2587&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2581&gt;&lt;U+2587&gt;</code></pre>
<p>Построим простую линейную регрессионную модель, на которой будем проверять гетероскедастичность.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">reg =<span class="st"> </span><span class="kw">lm</span>(ln_price_metr <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>ln_livesp <span class="op">+</span><span class="st"> </span>ln_kitsp <span class="op">+</span><span class="st"> </span>ln_dist <span class="op">+</span><span class="st"> </span>ln_metrdist, <span class="dt">data =</span> flats)
<span class="kw">summary</span>(reg)</code></pre></div>
<pre><code>
Call:
lm(formula = ln_price_metr ~ 1 + ln_livesp + ln_kitsp + ln_dist + 
    ln_metrdist, data = flats)

Residuals:
     Min       1Q   Median       3Q      Max 
-0.62723 -0.16125 -0.00845  0.13614  0.77618 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 14.19920    0.13492 105.243  &lt; 2e-16 ***
ln_livesp   -0.16053    0.03723  -4.312 1.83e-05 ***
ln_kitsp    -0.29913    0.02300 -13.007  &lt; 2e-16 ***
ln_dist     -0.33025    0.02367 -13.952  &lt; 2e-16 ***
ln_metrdist -0.05738    0.01560  -3.679 0.000251 ***
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1

Residual standard error: 0.2309 on 768 degrees of freedom
Multiple R-squared:  0.4179,    Adjusted R-squared:  0.4149 
F-statistic: 137.9 on 4 and 768 DF,  p-value: &lt; 2.2e-16</code></pre>
<p>Проверим наличие гетероскедастичности визуально. Построим зависимости цены квартир от объясняющих факторов.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">kit =<span class="st"> </span><span class="kw">ggplot</span>(flats) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> ln_kitsp, <span class="dt">y =</span> ln_price_metr)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Площадь кухни, кв.м&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;Цена квартиры, $1000&quot;</span>, 
  <span class="dt">title =</span> <span class="st">&quot;Стоимость квартир в Москве&quot;</span>)
live =<span class="st"> </span><span class="kw">ggplot</span>(flats) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> ln_livesp, <span class="dt">y =</span> ln_price_metr)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Жилая площадь, кв.м&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;Цена квартиры, $1000&quot;</span>, 
  <span class="dt">title =</span> <span class="st">&quot;Стоимость квартир в Москве&quot;</span>)
dist =<span class="st"> </span><span class="kw">ggplot</span>(flats) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> ln_dist, <span class="dt">y =</span> ln_price_metr)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Расстояние до центра, м&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;Цена квартиры, $1000&quot;</span>,
  <span class="dt">title =</span> <span class="st">&quot;Стоимость квартир в Москве&quot;</span>)
metrdist =<span class="st"> </span><span class="kw">ggplot</span>(flats) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> ln_metrdist, <span class="dt">y =</span> ln_price_metr)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Расстояние до метро, м&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;Цена квартиры, $1000&quot;</span>, 
  <span class="dt">title =</span> <span class="st">&quot;Стоимость квартир в Москве&quot;</span>)

<span class="kw">ggarrange</span>(kit, live, dist, metrdist, <span class="dt">ncol =</span> <span class="dv">2</span>, <span class="dt">nrow =</span> <span class="dv">2</span>)</code></pre></div>
<p><img src="10-heterosked_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
<p>Из сета красивых графиков видно, что гетероскедастичность присутствует. В частности, подозрительны переменные <code>ln_kitsp</code> и <code>ln_metrdist</code>.</p>
<p>Проверим наличие гетероскедастичности с помощью тестов.</p>
<p>Начнём с теста Уайта.</p>
<p>Тест Уайта реализуется в <strong>r</strong> (ручками) как:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">bptest</span>(reg, <span class="dt">varformula =</span> <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>ln_livesp <span class="op">+</span><span class="st"> </span>ln_kitsp <span class="op">+</span><span class="st"> </span>ln_dist <span class="op">+</span><span class="st"> </span>ln_metrdist <span class="op">+</span><span class="st"> </span><span class="kw">I</span>(ln_livesp <span class="op">^</span><span class="st"> </span><span class="dv">2</span>) <span class="op">+</span><span class="st"> </span><span class="kw">I</span>(ln_kitsp <span class="op">^</span><span class="st"> </span><span class="dv">2</span>) <span class="op">+</span><span class="st"> </span><span class="kw">I</span>(ln_dist <span class="op">^</span><span class="st"> </span><span class="dv">2</span>) <span class="op">+</span><span class="st"> </span><span class="kw">I</span>(ln_metrdist <span class="op">^</span><span class="st"> </span><span class="dv">2</span>) <span class="op">+</span><span class="st"> </span><span class="kw">I</span>(ln_livesp <span class="op">*</span><span class="st"> </span>ln_kitsp) <span class="op">+</span><span class="st"> </span><span class="kw">I</span>(ln_livesp <span class="op">*</span><span class="st"> </span>ln_dist) <span class="op">+</span><span class="st"> </span><span class="kw">I</span>(ln_livesp <span class="op">*</span><span class="st"> </span>ln_metrdist) <span class="op">+</span><span class="st"> </span><span class="kw">I</span>(ln_kitsp <span class="op">*</span><span class="st"> </span>ln_dist) <span class="op">+</span><span class="st"> </span><span class="kw">I</span>(ln_kitsp <span class="op">*</span><span class="st"> </span>ln_metrdist) <span class="op">+</span><span class="st"> </span><span class="kw">I</span>(ln_dist <span class="op">*</span><span class="st"> </span>ln_metrdist), <span class="dt">data =</span> flats)</code></pre></div>
<pre><code>
    studentized Breusch-Pagan test

data:  reg
BP = 89.02, df = 14, p-value = 5.81e-13</code></pre>
<p>Тест Уайта выявил гетероскедастичность.</p>
<p>Проведём тест Бройша - Пагана.</p>
<p>Классическая версия Бройша - Пагана реализуется в <strong>r</strong> по команде:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">bptest</span>(reg, <span class="dt">studentize =</span> <span class="ot">FALSE</span>)</code></pre></div>
<pre><code>
    Breusch-Pagan test

data:  reg
BP = 18.39, df = 4, p-value = 0.001035</code></pre>
<p>Модифицированная версия теста Бройша - Пагана реализуется по команде:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">bptest</span>(reg)</code></pre></div>
<pre><code>
    studentized Breusch-Pagan test

data:  reg
BP = 15.778, df = 4, p-value = 0.003332</code></pre>
<p>Причем, если отдельно не указать спецификацию вспомогательной регрессии, то <code>bptest()</code> возьмёт все регрессоры исходной модели.</p>
<p>В обеих версиях теста Бройша - Пагана гетероскедастичность обнаружена.</p>
<p>Ещё есть тест Голдфелда - Квандта.</p>
<p>Данный тест в <strong>r</strong> реализуется по командам (предполагается, что дисперсии пропорциональны переменной <code>ln_kitsp</code>):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">flats_ordered =<span class="st"> </span>flats[<span class="kw">order</span>(flats<span class="op">$</span>ln_kitsp), ]
reg_gqtest =<span class="st"> </span><span class="kw">lm</span>(ln_price_metr <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>ln_livesp <span class="op">+</span><span class="st"> </span>ln_kitsp <span class="op">+</span><span class="st"> </span>ln_dist <span class="op">+</span><span class="st"> </span>ln_metrdist, <span class="dt">data =</span> flats_ordered)
<span class="kw">gqtest</span>(reg_gqtest, <span class="dt">fraction =</span> <span class="fl">0.34</span>) <span class="co"># посередине отсортированного ряда лежит 34% наблюдений</span></code></pre></div>
<pre><code>
    Goldfeld-Quandt test

data:  reg_gqtest
GQ = 1.1072, df1 = 251, df2 = 250, p-value = 0.2106
alternative hypothesis: variance increases from segment 1 to 2</code></pre>
<p>Будет также полезным познакомиться с методами борьбы с гетероскедастичностью.</p>
<p>Способ 1. Взвешенный МНК. В <strong>r</strong> его можно осуществить так:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">reg_wls =<span class="st"> </span><span class="kw">lm</span>(ln_price_metr <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>ln_livesp <span class="op">+</span><span class="st"> </span>ln_kitsp <span class="op">+</span><span class="st"> </span>ln_dist <span class="op">+</span><span class="st"> </span>ln_metrdist, <span class="dt">data =</span> flats, <span class="dt">weights =</span> <span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">/</span><span class="st"> </span><span class="kw">fitted</span>(<span class="kw">lm</span>(<span class="kw">abs</span>(<span class="kw">residuals</span>(reg)) <span class="op">~</span><span class="st"> </span>ln_kitsp)) <span class="op">^</span><span class="st"> </span><span class="dv">2</span>))
<span class="kw">summary</span>(reg_wls)</code></pre></div>
<pre><code>
Call:
lm(formula = ln_price_metr ~ 1 + ln_livesp + ln_kitsp + ln_dist + 
    ln_metrdist, data = flats, weights = 1/(1/fitted(lm(abs(residuals(reg)) ~ 
    ln_kitsp))^2))

Weighted Residuals:
      Min        1Q    Median        3Q       Max 
-0.105299 -0.029659 -0.001107  0.025053  0.155867 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 14.28313    0.13557 105.357  &lt; 2e-16 ***
ln_livesp   -0.16102    0.03849  -4.183  3.2e-05 ***
ln_kitsp    -0.33901    0.02245 -15.098  &lt; 2e-16 ***
ln_dist     -0.33075    0.02406 -13.749  &lt; 2e-16 ***
ln_metrdist -0.05859    0.01587  -3.691 0.000239 ***
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1

Residual standard error: 0.04242 on 768 degrees of freedom
Multiple R-squared:  0.4683,    Adjusted R-squared:  0.4655 
F-statistic: 169.1 on 4 and 768 DF,  p-value: &lt; 2.2e-16</code></pre>
<p>Способ 2. Робастные оценки Уайта.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">coeftest</span>(reg, <span class="dt">vcov =</span> <span class="kw">vcovHC</span>(reg, <span class="st">&quot;HC0&quot;</span>))</code></pre></div>
<pre><code>
t test of coefficients:

             Estimate Std. Error  t value  Pr(&gt;|t|)    
(Intercept) 14.199195   0.158790  89.4210 &lt; 2.2e-16 ***
ln_livesp   -0.160528   0.040845  -3.9302 9.253e-05 ***
ln_kitsp    -0.299130   0.028398 -10.5336 &lt; 2.2e-16 ***
ln_dist     -0.330251   0.023965 -13.7803 &lt; 2.2e-16 ***
ln_metrdist -0.057375   0.014528  -3.9494 8.555e-05 ***
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p>Робастные оценки коэффициентов регрессии получаются состоятельными.</p>
</div>
<div id="python-5" class="section level2">
<h2><span class="header-section-number">8.2</span> Python</h2>
<p>Теперь попробуем проделать эти шаги в <strong>python</strong>.</p>
<p>Импотируем необходимые пакеты.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> numpy <span class="im">as</span> np
<span class="im">import</span> pandas <span class="im">as</span> pd <span class="co"># чтение файлов</span>
<span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt <span class="co"># построение графиков</span>
<span class="im">import</span> seaborn <span class="im">as</span> sns <span class="co"># построение графиков</span>
<span class="im">import</span> statsmodels.api <span class="im">as</span> sm <span class="co"># тесты</span>
<span class="im">from</span> statsmodels.formula.api <span class="im">import</span> ols, WLS <span class="co"># построение регрессии</span>
<span class="im">import</span> statsmodels
<span class="im">import</span> statsmodels.stats.diagnostic <span class="im">as</span> sm_diagnostic <span class="co"># тест Бройша-Пагана</span></code></pre></div>
<p>Загрузим исследуемый датасет.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">flats <span class="op">=</span> pd.read_stata(<span class="st">&quot;flats_10.dta&quot;</span>)<span class="op">;</span></code></pre></div>
<pre><code>Error in py_call_impl(callable, dots$args, dots$keywords): FileNotFoundError: [Errno 2] No such file or directory: &#39;flats_10.dta&#39;

Detailed traceback: 
  File &quot;&lt;string&gt;&quot;, line 1, in &lt;module&gt;
  File &quot;C:\Users\Yuliya\AppData\Local\Programs\Python\Python37\lib\site-packages\pandas\util\_decorators.py&quot;, line 188, in wrapper
    return func(*args, **kwargs)
  File &quot;C:\Users\Yuliya\AppData\Local\Programs\Python\Python37\lib\site-packages\pandas\util\_decorators.py&quot;, line 188, in wrapper
    return func(*args, **kwargs)
  File &quot;C:\Users\Yuliya\AppData\Local\Programs\Python\Python37\lib\site-packages\pandas\io\stata.py&quot;, line 186, in read_stata
    chunksize=chunksize)
  File &quot;C:\Users\Yuliya\AppData\Local\Programs\Python\Python37\lib\site-packages\pandas\util\_decorators.py&quot;, line 188, in wrapper
    return func(*args, **kwargs)
  File &quot;C:\Users\Yuliya\AppData\Local\Programs\Python\Python37\lib\site-packages\pandas\util\_decorators.py&quot;, line 188, in wrapper
    return func(*args, **kwargs)
  File &quot;C:\Users\Yuliya\AppData\Local\Programs\Python\Python37\lib\site-packages\pandas\io\stata.py&quot;, line 994, in __init__
    self.path_or_buf = open(path_or_buf, &#39;rb&#39;)</code></pre>
<p>Построим линейную регрессионную модель.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">reg <span class="op">=</span> ols(<span class="st">&quot;ln_price_metr ~ 1 + ln_livesp + ln_kitsp + ln_dist + ln_metrdist&quot;</span>, flats).fit()
reg.summary()</code></pre></div>
<pre><code>&lt;class &#39;statsmodels.iolib.summary.Summary&#39;&gt;
&quot;&quot;&quot;
                            OLS Regression Results                            
==============================================================================
Dep. Variable:          ln_price_metr   R-squared:                       0.418
Model:                            OLS   Adj. R-squared:                  0.415
Method:                 Least Squares   F-statistic:                     137.9
Date:                Sat, 18 Jan 2020   Prob (F-statistic):           9.06e-89
Time:                        00:44:35   Log-Likelihood:                 38.744
No. Observations:                 773   AIC:                            -67.49
Df Residuals:                     768   BIC:                            -44.24
Df Model:                           4                                         
Covariance Type:            nonrobust                                         
===============================================================================
                  coef    std err          t      P&gt;|t|      [0.025      0.975]
-------------------------------------------------------------------------------
Intercept      14.1992      0.135    105.243      0.000      13.934      14.464
ln_livesp      -0.1605      0.037     -4.312      0.000      -0.234      -0.087
ln_kitsp       -0.2991      0.023    -13.007      0.000      -0.344      -0.254
ln_dist        -0.3303      0.024    -13.952      0.000      -0.377      -0.284
ln_metrdist    -0.0574      0.016     -3.679      0.000      -0.088      -0.027
==============================================================================
Omnibus:                       25.080   Durbin-Watson:                   1.309
Prob(Omnibus):                  0.000   Jarque-Bera (JB):               26.855
Skew:                           0.425   Prob(JB):                     1.47e-06
Kurtosis:                       3.331   Cond. No.                         83.2
==============================================================================

Warnings:
[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
&quot;&quot;&quot;</code></pre>
<p>Визуализируем зависимости регрессоров и регрессанта.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">sns.pairplot(flats, x_vars<span class="op">=</span>[<span class="st">&quot;ln_metrdist&quot;</span>, <span class="st">&quot;ln_kitsp&quot;</span>, <span class="st">&quot;ln_livesp&quot;</span>, <span class="st">&quot;ln_dist&quot;</span>], y_vars<span class="op">=</span>[<span class="st">&quot;ln_price_metr&quot;</span>])</code></pre></div>
<pre><code>&lt;seaborn.axisgrid.PairGrid object at 0x0000000045387828&gt;</code></pre>
<p>Графики всё такие же красивые, как и в предыдущем пункте:) Подозрительны переменные <code>ln_kitsp</code> и <code>ln_metrdist</code>. Проведём тесты на выявление гетероскедастичности в <strong>python</strong>.</p>
<p>Рассмотрим тест Бройша - Пагана на всех факторах.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">resid <span class="op">=</span> reg.resid
X <span class="op">=</span> flats[[<span class="st">&quot;ln_livesp&quot;</span>, <span class="st">&quot;ln_kitsp&quot;</span>, <span class="st">&quot;ln_dist&quot;</span>, <span class="st">&quot;ln_metrdist&quot;</span>]]
sm_diagnostic.het_breuschpagan(resid<span class="op">=</span>resid, exog_het<span class="op">=</span>X)</code></pre></div>
<pre><code>(242.3887600398202, 2.8968538726873906e-52, 87.82180928009087, 1.8044481939655893e-61)</code></pre>
<p>Интерпретация результатов теста: Первое из выданных значений - значение тестовой статистики теста Бройша - Пагана, второе - значение p-value для выданной тестовой статистики. Третье и четвёртое - значения тестовой статистики и её p-value для на уровне значимости 5% (табличное). Гетероскедастичность присутствует.</p>
<p>Посмотрим на тест Голдфелда - Квандта по переменной <code>ln_kitsp</code>.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">sm_diagnostic.het_goldfeldquandt(y<span class="op">=</span>flats[<span class="st">&quot;ln_price_metr&quot;</span>], x<span class="op">=</span>X, alternative<span class="op">=</span><span class="st">&quot;two-sided&quot;</span>)</code></pre></div>
<pre><code>(0.5313881847525856, 8.826860679745173e-10, &#39;two-sided&#39;)</code></pre>
<p>Значение p-value близко к 0, следовательно, основная гипотеза о гомоскедастичности отвергается.</p>
<p>Теперь о способах борьбы с гетероскедастичностью.</p>
<p>Способ 1. Взвешенный МНК.</p>
<p>Взвешиваем по стандартному отклонению фактора <code>ln_kitsp</code>.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">reg_wls <span class="op">=</span> statsmodels.regression.linear_model.WLS(flats[<span class="st">&quot;ln_price_metr&quot;</span>], X, weights<span class="op">=</span>flats[<span class="st">&quot;ln_kitsp&quot;</span>])
reg_wls_results <span class="op">=</span> reg_wls.fit()
reg_wls_results.summary()</code></pre></div>
<pre><code>&lt;class &#39;statsmodels.iolib.summary.Summary&#39;&gt;
&quot;&quot;&quot;
                            WLS Regression Results                            
==============================================================================
Dep. Variable:          ln_price_metr   R-squared:                       0.995
Model:                            WLS   Adj. R-squared:                  0.995
Method:                 Least Squares   F-statistic:                 3.763e+04
Date:                Sat, 18 Jan 2020   Prob (F-statistic):               0.00
Time:                        00:44:36   Log-Likelihood:                -997.20
No. Observations:                 773   AIC:                             2002.
Df Residuals:                     769   BIC:                             2021.
Df Model:                           4                                         
Covariance Type:            nonrobust                                         
===============================================================================
                  coef    std err          t      P&gt;|t|      [0.025      0.975]
-------------------------------------------------------------------------------
ln_livesp       2.9582      0.071     41.469      0.000       2.818       3.098
ln_kitsp       -0.1256      0.095     -1.316      0.189      -0.313       0.062
ln_dist         1.1813      0.068     17.317      0.000       1.047       1.315
ln_metrdist     0.2429      0.057      4.259      0.000       0.131       0.355
==============================================================================
Omnibus:                       13.564   Durbin-Watson:                   1.132
Prob(Omnibus):                  0.001   Jarque-Bera (JB):               23.475
Skew:                          -0.050   Prob(JB):                     7.99e-06
Kurtosis:                       3.848   Cond. No.                         17.4
==============================================================================

Warnings:
[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
&quot;&quot;&quot;</code></pre>
<p>Способ 2. Использование робастных оценок.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">reg_robust <span class="op">=</span> reg.get_robustcov_results()
reg_robust.summary()</code></pre></div>
<pre><code>&lt;class &#39;statsmodels.iolib.summary.Summary&#39;&gt;
&quot;&quot;&quot;
                            OLS Regression Results                            
==============================================================================
Dep. Variable:          ln_price_metr   R-squared:                       0.418
Model:                            OLS   Adj. R-squared:                  0.415
Method:                 Least Squares   F-statistic:                     102.5
Date:                Sat, 18 Jan 2020   Prob (F-statistic):           5.95e-70
Time:                        00:44:36   Log-Likelihood:                 38.744
No. Observations:                 773   AIC:                            -67.49
Df Residuals:                     768   BIC:                            -44.24
Df Model:                           4                                         
Covariance Type:                  HC1                                         
===============================================================================
                  coef    std err          t      P&gt;|t|      [0.025      0.975]
-------------------------------------------------------------------------------
Intercept      14.1992      0.159     89.131      0.000      13.886      14.512
ln_livesp      -0.1605      0.041     -3.917      0.000      -0.241      -0.080
ln_kitsp       -0.2991      0.028    -10.500      0.000      -0.355      -0.243
ln_dist        -0.3303      0.024    -13.736      0.000      -0.377      -0.283
ln_metrdist    -0.0574      0.015     -3.937      0.000      -0.086      -0.029
==============================================================================
Omnibus:                       25.080   Durbin-Watson:                   1.309
Prob(Omnibus):                  0.000   Jarque-Bera (JB):               26.855
Skew:                           0.425   Prob(JB):                     1.47e-06
Kurtosis:                       3.331   Cond. No.                         83.2
==============================================================================

Warnings:
[1] Standard Errors are heteroscedasticity robust (HC1)
&quot;&quot;&quot;</code></pre>
</div>
<div id="stata-5" class="section level2">
<h2><span class="header-section-number">8.3</span> Stata</h2>
<p>Теперь попробуем поработать в <strong>stata</strong>.</p>
<p>Импортируем датасет для анализа командой <code>use flats_10.dta</code>.</p>
<p>Построим линейную регрессионную модель.</p>
<pre class="stata"><code>reg ln_price_metr ln_livesp ln_kitsp ln_dist ln_metrdist</code></pre>
<pre><code>      Source |       SS       df       MS              Number of obs =     773
-------------+------------------------------           F(  4,   768) =  137.86
       Model |  29.3972704     4  7.34931759           Prob &gt; F      =  0.0000
    Residual |  40.9421359   768  .053310073           R-squared     =  0.4179
-------------+------------------------------           Adj R-squared =  0.4149
       Total |  70.3394063   772  .091113221           Root MSE      =  .23089

------------------------------------------------------------------------------
ln_price_~tr |      Coef.   Std. Err.      t    P&gt;|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
   ln_livesp |  -.1605276   .0372309    -4.31   0.000    -.2336141   -.0874411
    ln_kitsp |  -.2991296   .0229974   -13.01   0.000    -.3442748   -.2539843
     ln_dist |  -.3302511   .0236707   -13.95   0.000    -.3767181   -.2837841
 ln_metrdist |  -.0573754   .0155965    -3.68   0.000    -.0879923   -.0267585
       _cons |    14.1992   .1349184   105.24   0.000     13.93434    14.46405
------------------------------------------------------------------------------</code></pre>
<p>Визуализируем зависимость регрессоров и регрессанта.</p>
<pre class="stata"><code></code></pre>
<pre><code>(file C:/Users/Yuliya/Documents/GitHub/bdemeshev/Econometrics-Rosetta-Stone/10/kitsp.png wri
&gt; tten in PNG format)</code></pre>
<div class="figure">
<img src="kitsp.png" />

</div>
<pre class="stata"><code>scatter ln_price_metr ln_livesp</code></pre>
<center>
<div class="figure">
<img src="livesp.png" />

</div>
</center>
<pre class="stata"><code>scatter ln_price_metr ln_dist</code></pre>
<center>
<div class="figure">
<img src="dist.png" />

</div>
</center>
<pre class="stata"><code>scatter ln_price_metr ln_metrdist</code></pre>
<center>
<div class="figure">
<img src="metrdist.png" />

</div>
</center>
<p>Подозрительны переменные <code>ln_kitsp</code> и <code>ln_metrdist</code>.</p>
<p>Проверим наличие гетероскедастичности с помощью тестов.</p>
<p>Тест Уайта строится по короткой команде:</p>
<pre class="stata"><code>estat imtest, white</code></pre>
<pre><code>last estimates not found
r(301);

end of do-file
r(301);</code></pre>
<p>Тест Уайта выявил гетероскедастичность. Что скажет тест Бройша - Пагана?</p>
<pre class="stata"><code>estat hettest, rhs mtest</code></pre>
<pre><code>last estimates not found
r(301);

end of do-file
r(301);</code></pre>
<p>И этот тест указывает на наличие нежелательной гетероскедастичности, особенно подозрительны переменные <code>ln_kitsp</code> и <code>ln_metrdist</code>.</p>
<p>Попробуем проверить ещё и через тест Голдфелда - Квандта. Сделаем его ручками.</p>
<p>Отсортируем наблюдения по возрастанию переменной <code>ln_kitsp</code>, построим регрессию и сохраним остатки.</p>
<pre class="stata"><code>sort ln_kitsp
reg ln_price_metr ln_livesp ln_kitsp ln_dist ln_metrdist in 1 / 258
scalar rss1 = e(rss)</code></pre>
<pre><code>no variables defined
r(111);

end of do-file
r(111);</code></pre>
<p>Сохраним остатки и в последней части регрессии.</p>
<pre class="stata"><code>sort ln_kitsp
reg ln_price_metr ln_livesp ln_kitsp ln_dist ln_metrdist in 516 / 773
scalar rss2 = e(rss)</code></pre>
<pre><code>no variables defined
r(111);

end of do-file
r(111);</code></pre>
<p>Посчитаем тестовую F-статистику.</p>
<pre class="stata"><code>scalar F = rss2 / rss1
display F
display invFtail(258, 258, 0.05)</code></pre>
<pre><code>rss2 not found
r(111);

end of do-file
r(111);</code></pre>
<p>Тестовая статистика больше табличной, следовательно, гетероскедастичность присутствует.</p>
<p>Сейчас немного о способах борьбы с гетероскедастичностью. Подправим все коэффициенты исходной регрессии на гетероскедастичную переменную, например, на <code>ln_kitsp</code>.</p>
<pre class="stata"><code>gen ln_price_metr_new = ln_price_metr / ln_kitsp
gen ln_livesp_new = ln_livesp / ln_kitsp
gen const_new = 1 / ln_kitsp
gen ln_dist_new = ln_dist / ln_kitsp
gen ln_metrdist_new = ln_metrdist / ln_kitsp</code></pre>
<pre><code>ln_price_metr not found
r(111);

end of do-file
r(111);</code></pre>
<p>И оценим регрессию с новыми переменными.</p>
<pre class="stata"><code>reg ln_price_metr_new ln_livesp_new const_new ln_dist_new ln_metrdist_new</code></pre>
<pre><code>no variables defined
r(111);

end of do-file
r(111);</code></pre>
<p>И полученные оценки будут эффективными оценками коэффициентов исходной регрессии.</p>
<p>Также можно использовать метод взвешенного МНК (WLS). Взвесим на стандартное отклонение фактора <code>ln_kitsp</code>.</p>
<pre class="stata"><code>vwls ln_price_metr ln_livesp ln_kitsp ln_dist ln_metrdist, sd(ln_kitsp)</code></pre>
<pre><code>variable ln_price_metr not found
r(111);

end of do-file
r(111);</code></pre>
<p>Способ #2. Используем робастные оценки Уайта.</p>
<pre class="stata"><code>reg ln_price_metr ln_livesp ln_kitsp ln_dist ln_metrdist, robust</code></pre>
<pre><code>no variables defined
r(111);

end of do-file
r(111);</code></pre>
<p>Робастные оценки Уайта позволяют снизить последствия гетероскедастичности через уменьшение стандартных ошибок коэффициентов регрессии.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="arma.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"download": ["Rosetta_Stone.pdf", "Rosetta_Stone.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
